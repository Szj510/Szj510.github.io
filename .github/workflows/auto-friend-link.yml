name: Auto add friend link

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: Issue number to process
        required: true

jobs:
  add:
    if: >-
      ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'issues' && github.event.label.name == 'friend-link-approved') }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read
      pull-requests: write
    env:
      ISSUE_NUMBER: ${{ github.event_name == 'workflow_dispatch' && inputs.issue_number || github.event.issue.number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm i js-yaml @octokit/rest

      - name: Update link.yml from issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const yaml = require('js-yaml');
          const { Octokit } = require('@octokit/rest');
          const issue_number = Number(process.env.ISSUE_NUMBER);
          const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');
          const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });
          (async () => {
            const { data: issue } = await octokit.issues.get({ owner, repo, issue_number });
            const body = issue.body || '';
            function pick(key) {
              const re = new RegExp('^\\s*' + key + '\\s*:\\s*(.+)$', 'mi');
              const m = body.match(re);
              return m ? m[1].trim() : '';
            }
            const entry = {
              name: pick('name'),
              link: pick('link'),
              avatar: pick('avatar'),
              descr: pick('descr')
            };
            if (!entry.name || !entry.link) {
              console.error('Missing required fields: name/link');
              process.exit(1);
            }
            const filePath = 'source/_data/link.yml';
            const content = fs.readFileSync(filePath, 'utf8');
            const doc = yaml.load(content);
            const arr = Array.isArray(doc) ? doc : [];
            let friends = arr.find(s => s.class_name && String(s.class_name).includes('朋友'));
            if (!friends) {
              friends = { class_name: '朋友的小站', class_desc: '互相学习，长期更新更佳', link_list: [] };
              arr.unshift(friends);
            }
            friends.link_list = friends.link_list || [];
            if (friends.link_list.some(i => i.link === entry.link)) {
              console.log('Link already exists, skip writing.');
            } else {
              friends.link_list.push(entry);
              fs.writeFileSync(filePath, yaml.dump(arr, { lineWidth: 1000, noRefs: true }), 'utf8');
            }
          })().catch(err => { console.error(err); process.exit(1); });
          NODE

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b auto/friend-link-${{ env.ISSUE_NUMBER }} || true
          git add source/_data/link.yml
          git commit -m "chore: add friend link from #${{ env.ISSUE_NUMBER }}" || echo "No changes to commit"
          git push -u origin HEAD

      - name: Create PR
        uses: actions/github-script@v7
        with:
          script: |
            const { context, github, core } = require('@actions/github');
            const issue_number = Number(process.env.ISSUE_NUMBER);
            const head = `auto/friend-link-${issue_number}`;
            const { data: repo } = await github.rest.repos.get(context.repo);
            const base = repo.default_branch || 'main';
            try {
              await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Add friend link from #${issue_number}`,
                head,
                base,
                body: `Auto-generated from issue #${issue_number}`
              });
            } catch (e) {
              core.warning(`PR create failed: ${e.message}`);
            }
